name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
  repository_dispatch:
    types: [pages-build]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.pages-check.outputs.enabled }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if GitHub Pages is enabled
        id: pages-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          status="$(curl -sS -o /tmp/pages.json -w '%{http_code}' \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pages" || true)"

          if [ "${status}" = "200" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "âœ… GitHub Pages already enabled for this repo."
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ GitHub Pages is not enabled (or not accessible)."
            echo "   API status: ${status}"
            echo "   One-time fix: Repo Settings â†’ Pages â†’ Source â†’ GitHub Actions"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          if [ -f package.json ]; then
            npm install
          else
            echo "âš ï¸  No package.json found in frontend directory"
            exit 1
          fi

      - name: Build TypeScript
        run: |
          cd frontend
          if [ -f tsconfig.json ]; then
            npm run build
            echo "âœ… TypeScript build completed"
            ls -la static/js/ || echo "âš ï¸  No JS files generated"
          else
            echo "âš ï¸  No tsconfig.json found, skipping TypeScript build"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
        if: steps.pages-check.outputs.enabled == 'true'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate static word list (free, no backend)
        run: |
          python3 -m pip install --upgrade pip
          pip install wordfreq requests
          python3 pages_generate_words.py
          # Note: words_translated.json generation takes hours (20k words * 10 langs)
          # Run manually: python3 pages_generate_translated_words.py
          # Or schedule via GitHub Actions cron if needed

      - name: Build static site
        run: |
          python3 build_static.py
          # Verify _site has static files
          echo "ğŸ“ Checking _site structure:"
          ls -la _site/ || echo "âŒ _site not found"
          ls -la _site/static/ || echo "âŒ _site/static not found"
          ls -la _site/static/css/ || echo "âŒ _site/static/css not found"
          ls -la _site/static/js/ || echo "âŒ _site/static/js not found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site
        if: steps.pages-check.outputs.enabled == 'true'
        
      - name: Debug artifact contents
        if: steps.pages-check.outputs.enabled == 'true'
        run: |
          echo "ğŸ“¦ Artifact directory structure:"
          find _site -type f -name "*.css" -o -name "*.js" -o -name "*.json" | head -20
          echo ""
          echo "ğŸ“„ index.html references:"
          grep -E "href=|src=" _site/index.html | grep -E "css|js" | head -5
          
      - name: Verify build output
        run: |
          echo "ğŸ“¦ Built files:"
          ls -la _site/ || echo "âŒ _site directory not found"
          echo ""
          echo "ğŸ“ Static directory:"
          ls -la _site/static/ || echo "âš ï¸  No static directory"
          echo ""
          echo "ğŸ“„ Checking index.html:"
          if [ -f _site/index.html ]; then
            echo "âœ… index.html exists"
            head -n 10 _site/index.html
          else
            echo "âŒ index.html not found"
            exit 1
          fi
          echo ""
          echo "â„¹ï¸ Pages enabled? ${{ steps.pages-check.outputs.enabled }}"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.enabled == 'true'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
